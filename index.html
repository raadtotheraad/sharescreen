<!DOCTYPE html>
<html>
<head>
  <title>Screen Share</title>
  <meta charset="UTF-8">
</head>
<body style="margin:0;">
  <video id="video" autoplay playsinline style="width:100vw; height:100vh; object-fit:contain;"></video>

  <script>
    window.onload = () => {
      const ws = new WebSocket('wss://sharescreenserver-toum.onrender.com');
      const video = document.getElementById('video');
      const urlParams = new URLSearchParams(window.location.search);
      const role = urlParams.get('role'); // 'broadcaster' or 'viewer'
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

      let myId = null;
      let localStream;
      const peerConnections = {}; // broadcaster's peer connections
      let viewerPeerConnection = null;

      ws.onopen = () => {
        console.log('[WS] Connected');
        if (role === 'broadcaster') {
          ws.send(JSON.stringify({ type: 'broadcaster' }));
          startBroadcast();
        } else {
          ws.send(JSON.stringify({ type: 'viewer' }));
        }
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log('[WS] Received:', data);

        if (data.type === 'viewer-id') {
          myId = data.id;
          console.log('[Viewer] Assigned ID:', myId);
        }

        if (role === 'broadcaster') {
          if (data.type === 'new-viewer') {
            const viewerId = data.id;
            const pc = new RTCPeerConnection(config);
            peerConnections[viewerId] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = e => {
              if (e.candidate) {
                ws.send(JSON.stringify({
                  type: 'candidate',
                  candidate: e.candidate,
                  target: viewerId,
                  source: 'broadcaster'
                }));
              }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({
              type: 'offer',
              sdp: offer.sdp,
              target: viewerId,
              source: 'broadcaster'
            }));
          }

          if (data.type === 'answer') {
            const pc = peerConnections[data.source];
            if (pc) {
              await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
            }
          }

          if (data.type === 'candidate') {
            const pc = peerConnections[data.source];
            if (pc && data.candidate) {
              try {
                await pc.addIceCandidate(data.candidate);
              } catch (err) {
                console.error('[Broadcaster] Error adding ICE candidate:', err);
              }
            }
          }
        }

        if (role === 'viewer') {
          if (data.type === 'offer') {
            console.log('[Viewer] Received offer');
            const pc = new RTCPeerConnection(config);
            viewerPeerConnection = pc;

            pc.ontrack = e => {
              console.log('[Viewer] Received track');
              video.srcObject = e.streams[0];
            };

            pc.onicecandidate = e => {
              if (e.candidate) {
                console.log('[Viewer] Sending ICE candidate');
                ws.send(JSON.stringify({
                  type: 'candidate',
                  candidate: e.candidate,
                  source: myId,
                  target: data.source
                }));
              }
            };

            try {
              await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);

              ws.send(JSON.stringify({
                type: 'answer',
                sdp: answer.sdp,
                source: myId,
                target: data.source
              }));
              console.log('[Viewer] Answer sent âœ…');
            } catch (err) {
              console.error('[Viewer] Error handling offer:', err);
            }
          }

          if (data.type === 'candidate' && viewerPeerConnection) {
            try {
              await viewerPeerConnection.addIceCandidate(data.candidate);
            } catch (err) {
              console.error('[Viewer] Error adding ICE candidate:', err);
            }
          }
        }
      };

      async function startBroadcast() {
        try {
          localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          video.srcObject = localStream;
          console.log('[Broadcaster] Screen sharing started');
        } catch (err) {
          alert('Failed to share screen: ' + err.message);
        }
      }
    };
  </script>
</body>
</html>
