<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Screen Share</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100vh; width: 100vw; background: black;
      display: flex; justify-content: center; align-items: center;
      flex-direction: column;
      color: white;
    }
    video {
      width: 100vw; height: 100vh; object-fit: contain;
      background: black;
    }
    button {
      position: absolute;
      top: 20px;
      z-index: 10;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="startBroadcastBtn" style="display:none;">Start Broadcast</button>
  <video id="video" autoplay playsinline></video>

  <script>
    (async () => {
      const signalingUrl = 'wss://your-render-url'; // <<< REPLACE THIS
      const ws = new WebSocket(signalingUrl);
      const video = document.getElementById('video');
      const startBroadcastBtn = document.getElementById('startBroadcastBtn');
      const params = new URLSearchParams(window.location.search);
      const role = params.get('role'); // 'broadcaster' or 'viewer'
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

      let clientId = null;
      let localStream = null;
      const peerConnections = {};
      let peerConnection = null;
      let pendingCandidates = [];

      ws.onopen = () => {
        console.log('[WS] Connected');
        ws.send(JSON.stringify({ type: role }));
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'id') {
          clientId = data.id;
          console.log('[WS] Assigned client id:', clientId);
          if (role === 'broadcaster') {
            // Show button for user to start screen share
            startBroadcastBtn.style.display = 'block';
          } else if (role === 'viewer') {
            startViewing();
          }
          return;
        }

        console.log('[WS] Received:', data);

        if (role === 'broadcaster') {
          if (data.type === 'new-viewer' && data.id) {
            const viewerId = data.id;
            console.log('[Broadcaster] New viewer:', viewerId);

            const pc = new RTCPeerConnection(config);
            peerConnections[viewerId] = pc;

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = e => {
              if (e.candidate) {
                ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, to: viewerId, from: clientId }));
              }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp, to: viewerId, from: clientId }));
            console.log('[Broadcaster] Sent offer to viewer', viewerId);
          }
          else if (data.type === 'answer' && data.from) {
            const pc = peerConnections[data.from];
            if (pc) {
              await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
              console.log('[Broadcaster] Set remote description for viewer', data.from);
            }
          }
          else if (data.type === 'candidate' && data.from) {
            const pc = peerConnections[data.from];
            if (pc) {
              try {
                await pc.addIceCandidate(data.candidate);
                console.log('[Broadcaster] Added ICE candidate from viewer', data.from);
              } catch (e) {
                console.error('[Broadcaster] Failed to add ICE candidate:', e);
              }
            }
          }
          return;
        }

        if (role === 'viewer') {
          if (data.type === 'offer' && data.sdp) {
            if (!peerConnection) createPeerConnection();

            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));

            for (const c of pendingCandidates) {
              try {
                await peerConnection.addIceCandidate(c);
              } catch (e) {
                console.error('[Viewer] Failed to add queued ICE candidate:', e);
              }
            }
            pendingCandidates = [];

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp, to: data.from, from: clientId }));
            console.log('[Viewer] Sent answer to broadcaster');
          }
          else if (data.type === 'candidate') {
            if (peerConnection && peerConnection.remoteDescription && peerConnection.remoteDescription.type) {
              try {
                await peerConnection.addIceCandidate(data.candidate);
                console.log('[Viewer] Added ICE candidate');
              } catch (e) {
                console.error('[Viewer] Failed to add ICE candidate:', e);
              }
            } else {
              pendingCandidates.push(data.candidate);
              console.log('[Viewer] Queued ICE candidate');
            }
          }
          return;
        }
      };

      startBroadcastBtn.onclick = async () => {
        try {
          localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          video.srcObject = localStream;
          console.log('[Broadcaster] Screen sharing started');
          startBroadcastBtn.style.display = 'none';
        } catch (err) {
          alert('Failed to share screen: ' + err.message);
        }
      };

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection(config);

        peerConnection.ontrack = event => {
          console.log('[Viewer] Received remote track');
          video.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, from: clientId }));
          }
        };

        peerConnection.onconnectionstatechange = () => {
          console.log('[Viewer] Connection state:', peerConnection.connectionState);
          if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
            video.srcObject = null;
          }
        };
      }

      function startViewing() {
        console.log('[Viewer] Ready to receive stream');
      }
    })();
  </script>
</body>
</html>
