<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Screen Share</title>
  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
    }

    #video {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      display: none;
    }

    #startBroadcastBtn {
      position: absolute;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      background: #ff3b3b;
      color: white;
      border: none;
      border-radius: 1.5rem;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(255, 59, 59, 0.4);
      animation: pulseRed 1.5s infinite ease-in-out;
      z-index: 10;
    }

    @keyframes pulseRed {
      0%   { transform: scale(1); box-shadow: 0 0 20px rgba(255, 59, 59, 0.4); }
      50%  { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 59, 59, 0.8); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 59, 59, 0.4); }
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <button id="startBroadcastBtn" style="display: none;">Start Broadcasting</button>

  <script>
    const signalingUrl = 'wss://sharescreenserver-toum.onrender.com'; // your server
    const ws = new WebSocket(signalingUrl);
    const video = document.getElementById('video');
    const startBroadcastBtn = document.getElementById('startBroadcastBtn');

    const params = new URLSearchParams(window.location.search);
    const role = params.get('role');
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    let peerConnection;
    let localStream;
    let pendingCandidates = [];

    ws.onopen = () => {
      console.log('[WS] Connected');
      if (role === 'broadcaster') {
        startBroadcastBtn.style.display = 'block';
      } else if (role === 'viewer') {
        ws.send(JSON.stringify({ type: 'viewer' }));
        startViewing();
      } else {
        alert("Specify '?role=broadcaster' or '?role=viewer' in the URL.");
      }
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      console.log('[WS] Received:', data);

      if (role === 'broadcaster') {
        if (data.type === 'new-viewer') {
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));
        } else if (data.type === 'answer') {
          await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
        } else if (data.type === 'candidate') {
          try {
            await peerConnection.addIceCandidate(data.candidate);
          } catch (e) {
            console.error('Broadcaster failed to add ICE candidate:', e);
          }
        }
        return;
      }

      if (role === 'viewer') {
        if (data.type === 'offer') {
          if (!peerConnection) createPeerConnection();
          await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));

          for (const c of pendingCandidates) {
            try {
              await peerConnection.addIceCandidate(c);
            } catch (e) {
              console.error('Failed to add queued candidate:', e);
            }
          }
          pendingCandidates = [];

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
        } else if (data.type === 'candidate') {
          if (peerConnection?.remoteDescription) {
            try {
              await peerConnection.addIceCandidate(data.candidate);
            } catch (e) {
              console.error('Failed to add ICE candidate:', e);
            }
          } else {
            pendingCandidates.push(data.candidate);
          }
        }
      }
    };

    startBroadcastBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        video.srcObject = localStream;
        video.style.display = 'block';
        startBroadcastBtn.style.display = 'none';

        peerConnection = new RTCPeerConnection(config);

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
          }
        };

        ws.send(JSON.stringify({ type: 'broadcaster' }));
        console.log('[Broadcaster] Screen sharing started');
      } catch (err) {
        alert('Failed to share screen: ' + err.message);
      }
    };

    function createPeerConnection() {
      peerConnection = new RTCPeerConnection(config);

      peerConnection.ontrack = event => {
        video.srcObject = event.streams[0];
        video.style.display = 'block';
        console.log('[Viewer] Stream received');
      };

      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
        }
      };
    }

    function startViewing() {
      createPeerConnection();
    }
  </script>
</body>
</html>
