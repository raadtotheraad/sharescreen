<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Screen Share</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100vh; width: 100vw; background: black;
      display: flex; justify-content: center; align-items: center;
    }
    video {
      width: 100vw; height: 100vh; object-fit: contain;
      background: black;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>

  <script>
    (async () => {
      const signalingUrl = 'wss://your-render-url'; // <-- Replace this!
      const ws = new WebSocket(signalingUrl);
      const video = document.getElementById('video');
      const params = new URLSearchParams(window.location.search);
      const role = params.get('role'); // 'broadcaster' or 'viewer'
      const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

      let peerConnection;
      let localStream;
      let pendingCandidates = [];

      ws.onopen = () => {
        console.log('[WS] Connected');
        if (role === 'broadcaster') {
          ws.send(JSON.stringify({ type: 'broadcaster' }));
          startBroadcast();
        } else if (role === 'viewer') {
          ws.send(JSON.stringify({ type: 'viewer' }));
          startViewing();
        } else {
          alert('Please specify role in URL: ?role=broadcaster or ?role=viewer');
        }
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log('[WS] Received:', data);

        if (role === 'broadcaster') {
          if (data.type === 'new-viewer') {
            // When a new viewer arrives, create offer
            if (!peerConnection) {
              console.warn('Broadcaster currently supports one viewer only');
              return;
            }
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));
          } else if (data.type === 'answer') {
            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.sdp }));
          } else if (data.type === 'candidate') {
            try {
              await peerConnection.addIceCandidate(data.candidate);
            } catch (e) {
              console.error('Broadcaster failed to add ICE candidate:', e);
            }
          }
          return;
        }

        if (role === 'viewer') {
          if (data.type === 'offer') {
            if (!peerConnection) createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.sdp }));

            // Add any queued ICE candidates
            for (const c of pendingCandidates) {
              try {
                await peerConnection.addIceCandidate(c);
              } catch(e) {
                console.error('Failed to add queued candidate', e);
              }
            }
            pendingCandidates = [];

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
            console.log('[Viewer] Sent answer');
          } else if (data.type === 'candidate') {
            if (peerConnection && peerConnection.remoteDescription && peerConnection.remoteDescription.type) {
              try {
                await peerConnection.addIceCandidate(data.candidate);
              } catch (e) {
                console.error('Failed to add ICE candidate:', e);
              }
            } else {
              pendingCandidates.push(data.candidate);
            }
          }
        }
      };

      async function startBroadcast() {
        try {
          localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          video.srcObject = localStream;

          peerConnection = new RTCPeerConnection(config);

          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

          peerConnection.onicecandidate = e => {
            if (e.candidate) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
            }
          };

          console.log('[Broadcaster] Screen sharing started');
        } catch (err) {
          alert('Failed to share screen: ' + err.message);
        }
      }

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection(config);

        peerConnection.ontrack = event => {
          console.log('[Viewer] Received track');
          video.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
          }
        };
      }

      function startViewing() {
        createPeerConnection();
      }
    })();
  </script>
</body>
</html>
